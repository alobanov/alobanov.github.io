---
layout: post
title: Валидируем
description: Цепочка обязанностей
categories: article
tags:
  - composite
  - ios
  - swift
---

# Мотивы

Необходимо последовательно провести ряд проверок над данными, а затем применить для них ряд изменений. Причем порядок проверок и изменений хотелось бы применять в разном порядке для разных случаев. Например нам надо проверить строку с телефонным номером:

1. Строка не должна быть пустой и не <span class="wordcode">nil</span>
2. Строка должна содержать определенное количество символов
3. Необходимо отформатировать строку с учетом указанного формата

> **Цепочка обязанностей** — это поведенческий паттерн проектирования, который позволяет передавать запросы последовательно по цепочке обработчиков. Каждый последующий обработчик решает, может ли он обработать запрос сам и стоит ли передавать запрос дальше по цепи.

Проект с [примером][2] на Git-Hub :octocat:

---

# Реализация

Напишем общий интерфейс для всех обработчиков <span class="wordcode">MiddlewareProtocol</span>:

{% highlight swift %}
protocol MiddlewareProtocol {
  // Связываем текущий и следующий экземпляр проверки
  @discardableResult func link(with: MiddlewareProtocol) -> MiddlewareProtocol
  // Этот метод необходимо перегрузить и реализовать свой вариант проверки
  func check(value: MiddlewareItem) -> MiddlewareItem
  // Вспомогательный метод для упрощения вызова следующей проверки в цепочке
  func checkNext(value: MiddlewareItem) -> MiddlewareItem
}
{% endhighlight %}

Также создадим перечисление <span class="wordcode">MiddlewareItem</span> -- этот тип данных содержит само значение <span class="wordcode">.value</span> и ошибку <span class="wordcode">.error</span> если мы не прошли валидацию:

{% highlight swift %}
public enum MiddlewareItem {
  case value(String?)
  case error(String)
}
{% endhighlight %}

Напишем базовую реализацию обработчика <span class="wordcode">MiddlewareProtocol</span>:

{% highlight swift %}
class Middleware: MiddlewareProtocol {
  var next: MiddlewareProtocol?

  @discardableResult func link(with: MiddlewareProtocol) -> MiddlewareProtocol {
    self.next = with
    return with
  }

  func check(value: MiddlewareItem) -> MiddlewareItem {
    return checkNext(value: value)
  }

  func checkNext(value: MiddlewareItem) -> MiddlewareItem {
    guard let next = self.next else { return value }
    return next.check(value: value)
  }
}
{% endhighlight %}

#### Все обработчики проверок и модификации необходимо наследовать от Middleware

Теперь можно написать дополнительные обработчики для валидации и изменений:

1. Обработчик проверки на <span class="wordcode">nil</span> и пустую строку: <span class="wordcode">CheckNilMiddleware</span>
2. Обработчик проверки на длинну строки: <span class="wordcode">CheckCountMiddleware</span>
3. Обработчик который форматирует строку с учетом указанного формата: <span class="wordcode">PhoneFormatterMiddleware</span>

Реализация всех трех классов описаных выше, жмите на [ссылуку][1] :octocat:.

---

# Разберем подробнее

* Каждый обработчик должен наследоваться от <span class="wordcode">Middleware</span>, далее перегружем метод <span class="wordcode">override func check(value: MiddlewareItem) -> MiddlewareItem</span>.
* В нем реализуем проверку или форматируем данные <span class="wordcode">.value(let val)</span>.
* Если все успешно вызываем следующую проверку в нашем списке цепочек <span class="wordcode">return checkNext(value: value)</span>. Иначе сразу возвращаем ошибку <span class="wordcode">return .error("Example error text")</span>.
* если хотим подменить данные то передаем новое значение <span class="wordcode">return checkNext(value: .value("New value"))</span>

{% highlight swift %}
override func check(value: MiddlewareItem) -> MiddlewareItem {
    switch value {
    case .value(let str):
      if str == nil { // Выполняем проверку
        // Валидация не прошла, возвращаем ошибку
        return .error("Example error text")
      }
    default:
      break
    }
    // Если все успешно вызываем следующую
    // проверку в нашем списке цепочек
    return checkNext(value: value)
  }
{% endhighlight %}

#### Читай комментарии к коду

---

## Использование

Попробуем проверить и отформатировать телефонный номер с помощью нашей реализации:

{% highlight swift %}
let start = Middleware()
start
  .link(with: CheckNilMiddleware())
  .link(with: CheckCountMiddleware(length: 11))
  .link(with: PhoneFormatterMiddleware(format: "+X (XXX) XXX XX-XX"))

let result = start.check(value: .value("79634480209")))

switch result {
case .error(let error): print(error)
case .value(let result): print(result ?? "")
}
{% endhighlight %}

Вывод в консоль: <span class="wordcode">+7 (963) 448 02-09</span>

---

## В заключении

Где еще можно использовать:

* добавить обработчики которые будут выполнять манипуляции над изображением, таким образом получим удобный способ применять фильтры для изображения (как пример можно [посмотреть реализацию][3] в фреймворке Kingfisher)
* валидация при авторизации или регистрации пользователя
* когда необходимо чтобы обработчики выполнялись один за другим

#### Есть вопросы? Пишите сюда – [@alobanov](https://twitter.com/alobanov)

[1]: https://github.com/alobanov/ExampleArticleComposite/tree/master/chainOfResponsibilityValidation/chainOfResponsibilityValidation.playground
[2]: https://gist.github.com/alobanov/30dec2f118532b4cc32d82bc321ac1bd
[3]: https://github.com/onevcat/Kingfisher/blob/master/Sources/ImageProcessor.swift
