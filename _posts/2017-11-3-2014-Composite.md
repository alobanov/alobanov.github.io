---
layout: post
title: Компоновщик
description: Структура данных для UITableView
categories: article
tags:
  - composite
  - ios
  - swift
---

# Суть проблемы

Часто в приложениях встречаются табличные представления <span class="wordcode">UITableView</span>, <span class="wordcode">UICollectionView</span>. Раньше в зависимости от задачи я использовал в качестве структуры данных массив либо словарь. Это решение несло ряд ограничений и не было гибким. Для меня более удобным стало использование [**компоновщика**][1].

> **Компоновщик** — структурный паттерн проектирования. Он позволяет сгруппировать объекты в древовидную структуру, а затем работать с ними как с единым объектом.

Проект с [примером][3] на Git-Hub :octocat:

---

### Теория

Как будет выглядеть наше дерево? Табличное представление состоит из списка <span class="wordcode">секций</span>. В свою очередь секции состоят из набора <span class="wordcode">моделей</span> ячеек (тоже самое для коллекций). 

**Контейнер** (или Композит) — составной элемент дерева. Содержит дочерние элементы — Листья или другие Контейнеры — но не знает, какие именно, так как работает с ними только через общий интерфейс Компонента (<span class="wordcode">CompoundItemProtocol</span>).

Методы этого класса переадресуют основную работу своим дочерним компонентам, хотя и могут добавлять что-то своё к результату.

Таким образом, паттерн Компоновщик позволяет нам работать с деревьями объектов любой сложности, не обращая внимание на конкретные модели, формирующие дерево.

---

## Реализация

Напишем общий интерфейс для элементов дерева:

<script src="https://gist.github.com/alobanov/67bb633143ab5340328be8e9814c27e0.js"></script>

#### Базовый протокол для всех моделей дерева и перечисление его уровней

<br/>

Базовый класс, реализующий общий протокол для всех элементов дерева:

<script src="https://gist.github.com/alobanov/6858458b24cadc7f7dce6ea6106e2222.js"></script>

---

Базовые реализация готова, на ее основе можно добавить конкретные модели: <span class="wordcode">секций</span> и <span class="wordcode">ячеек</span>. Для создания модели элементов дерева будем использовать паттерн [**декоратор**][2], чтобы расширить нашу базовую реализацию <span class="wordcode">BaseCompoundItem</span>. Этот структурный паттерн позволит динамически добавить объектам новую функциональность, используя так называемые обвертки.

Напишем модель для <span class="wordcode">секции</span>:

<script src="https://gist.github.com/alobanov/90c513a5c906937f5959084f1c02e6f7.js"></script>

И модель для <span class="wordcode">ячеки</span>:

<script src="https://gist.github.com/alobanov/11e1e95eba62aa4e70857fcebe0d96ca.js"></script>

---

## Использование

Все готово, можно опробовать нашу новую структуру данных:

<script src="https://gist.github.com/alobanov/a2c1880e5e52d0cfcd0b17d9edcfe8e4.js"></script>

Теперь выполняем <span class="wordcode">tableView.reloadData()</span> и готово. Посмотреть пример кода можно [тут][3] :octocat: .

---

## В заключении

Что полезного можно добавить:

* Фильтры в модели ячеек. Добавим дополнительный параметр <span class="wordcode">isVisible</span> — от него зависит, будут ли модели возвращаться. 
{% highlight swift %}
// CellCompoundItem
var isVisible = false
var items: [CompoundItemProtocol] {
    return self.isVisible ? [self] : []
}
{% endhighlight %}
* Проверка валидации всех полей таблицы. Добавляем новый метод <span class="wordcode">func isValid() -> Bool</span> в <span class="wordcode">CompoudItemProtocol</span>. Реализуем его во всех моделях ячеек нашего дерева.
* Проверка изменений данных таблицы при создании сложных форм ввода данных (создается по аналогии с п. 2).
 
#### Есть вопросы? Пишите сюда – [@alobanov](https://twitter.com/alobanov)

[1]: https://ru.wikipedia.org/wiki/%D0%9A%D0%BE%D0%BC%D0%BF%D0%BE%D0%BD%D0%BE%D0%B2%D1%89%D0%B8%D0%BA
[2]: https://ru.wikipedia.org/wiki/%D0%94%D0%B5%D0%BA%D0%BE%D1%80%D0%B0%D1%82%D0%BE%D1%80_(%D1%88%D0%B0%D0%B1%D0%BB%D0%BE%D0%BD_%D0%BF%D1%80%D0%BE%D0%B5%D0%BA%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F)
[3]: https://github.com/alobanov/ExampleArticleComposite

[image-1]: /images/compositeTableView.png
